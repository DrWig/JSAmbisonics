<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <meta name="description" content="Web Audio ambisonic library tests"/>
        <meta name="author" content="Archontis Politis"/>
        <title>Ambisonics on the browser: B-format Player</title>
    </head>
    <body>
        
        <h1>B-format player and binaural decoder</h1>
        
        Select sample:
        <select id="sample_no" onchange="changeSample()">
            <option value="./sounds/BF_rec1.wav">1</option>
            <option value="./sounds/BF_rec2.wav">2</option>
            <option value="./sounds/BF_rec3.wav">3</option>
            <option value="./sounds/BF_rec4.wav">4</option>
            <option value="./sounds/BF_rec5.wav">5</option>
        </select>
        
        <button id="play">Play</button> <button id="stop">Stop</button>
        <br>
                
        <footer>
            <hr>
            <p>Archontis Politis, 2016</p>
            <a href="mailto:archontis.politis@aalto.fi">archontis.politis@aalto.fi</a>
        </footer>
        
        <script type="text/javascript" src="../WebAudio_FOA.js"></script>
        
        <script>

            ////////////////////////////////////////////////
            // SET-UP WEB AUDIO CONTEXT AND SOUND PROCESSING
            var AudioContext = window.AudioContext // Default
                || window.webkitAudioContext; // Safari and old versions of Chrome
            var context = new AudioContext; // Create and Initialize the Audio Context
            var soundUrl = "./sounds/BF_rec1.wav";
            var irUrl = "./filters/BF_filters_direct.wav";
            var soundBuffer, sound;

            // initialize binaural decoder object and connect to output
            var decoder = new Bformat_binDecoder(context);
            decoder.out.connect(context.destination);
            
            // function to load samples
            function loadSample(url, doAfterLoading) {
                var fetchSound = new XMLHttpRequest(); // Load the Sound with XMLHttpRequest
                fetchSound.open("GET", url, true); // Path to Audio File
                fetchSound.responseType = "arraybuffer"; // Read as Binary Data
                fetchSound.onload = function() {
                    context.decodeAudioData(fetchSound.response, doAfterLoading);
                }
                fetchSound.send();
            }
            // function to assign sample to the sound buffer for playback (and enable playbutton)
            var assignSample2SoundBuffer = function(decodedBuffer) {
                soundBuffer = decodedBuffer;
                document.getElementById('play').disabled = false;
            }
            // function to assign sample to the filter buffers for convolution
            var assignSample2Filters = function(decodedBuffer) {
                decoder.updateFilters(decodedBuffer);
            }
            
            // load and assign samples
            document.getElementById('play').disabled = true;
            document.getElementById('stop').disabled = true;
            loadSample(soundUrl, assignSample2SoundBuffer);
            loadSample(irUrl, assignSample2Filters);

            // handle buttons
            document.getElementById('play').addEventListener('click', function() {
                                                             sound = context.createBufferSource();
                                                             sound.buffer = soundBuffer;
                                                             sound.loop = true;
                                                             sound.connect(decoder.in);
                                                             sound.start(0);
                                                             sound.isPlaying = true;
                                                             document.getElementById('play').disabled = true;
                                                             document.getElementById('stop').disabled = false;
                                                             });
            document.getElementById('stop').addEventListener('click', function() {
                                                             sound.stop(0);
                                                             sound.isPlaying = false;
                                                             document.getElementById('play').disabled = false;
                                                             document.getElementById('stop').disabled = true;
                                                             });
                                                             
            function changeSample() {
                document.getElementById('play').disabled = true;
                document.getElementById('stop').disabled = true;
                soundUrl = document.getElementById("sample_no").value;
                if (sound.isPlaying) {
                    sound.stop(0);
                    sound.isPlaying = false;
                }
                loadSample(soundUrl, assignSample2SoundBuffer);
            }

        </script>

    </body>
</html>