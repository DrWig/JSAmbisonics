<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="description" content="Web Audio ambisonic library tests"/>
        <meta name="author" content="Archontis Politis"/>
        <title>Ambisonics on the browser: HOA Player</title>
    </head>
    <body>
        
        <h1>HOA-player and binaural decoder</h1>

        Select sample:
        <select id="sample_no" onchange="changeSample()">
            <option value="./sounds/HOA3_rec1.wav">1</option>
            <option value="./sounds/HOA3_rec2.wav">2</option>
            <option value="./sounds/HOA3_rec3.wav">3</option>
            <option value="./sounds/HOA3_rec4.wav">4</option>
        </select>

        <button id="play">Play</button> <button id="stop">Stop</button>
        <br>
        <p> Order: <span id="order-value">1</span></p>
        <button id="N1">1st</button> <button id="N2">2nd</button> <button id="N3">3rd</button>
        <br>
        
        <footer>
            <hr>
            <p>Archontis Politis, 2016</p>
            <a href="mailto:archontis.politis@aalto.fi">archontis.politis@aalto.fi</a>
        </footer>
        
        <script src="../numeric-1.2.6.min.js"></script>
        <script src="../JSHlib.js"></script>
        <script src="../WebAudio_HOA.js"></script>

        <script src="../HOAloader.js"></script>

        <script>


            // SET-UP AUDIO CONTEXT AND SOUND VARIABLES
            var AudioContext = window.AudioContext // Default
            || window.webkitAudioContext; // Safari and old versions of Chrome
            var context = new AudioContext; // Create and Initialize the Audio Context
            var soundUrl = "./sounds/HOA3_rec1.wav";
            var irUrl = "./filters/HOA3_filters_direct.wav";
            var orderValue = document.getElementById('order-value');
            var soundBuffer, sound;
            var maxOrder = 3;
            var orderOut = 1;

            // initialize order limiter to show order effect
            var limiter = new HOA_orderLimiter(context, maxOrder, orderOut);
            // initialize decoder
            var decoder = new HOA_binDecoder(context, maxOrder);
            // make connections
            limiter.out.connect(decoder.in);
            decoder.out.connect(context.destination);

            // disable buttons before loading
            document.getElementById('play').disabled = true;
            document.getElementById('stop').disabled = true;
            // load samples and assign to buffers
            var assignSoundBufferOnLoad = function(buffer) {
                soundBuffer = buffer;
                document.getElementById('play').disabled = false;
            }
            var loader_sound = new HOAloader(context, maxOrder, soundUrl, assignSoundBufferOnLoad);
            loader_sound.load();
            // load filters and assign to buffers
            var assignFiltersOnLoad = function(buffer) {
                decoder.updateFilters(buffer);
            }
            var loader_filters = new HOAloader(context, maxOrder, irUrl, assignFiltersOnLoad);
            loader_filters.load();

            // handle buttons
            document.getElementById('play').addEventListener('click', function() {
                                                             sound = context.createBufferSource();
                                                             sound.buffer = soundBuffer;
                                                             sound.loop = true;
                                                             sound.connect(limiter.in);
                                                             sound.start(0);
                                                             sound.isPlaying = true;
                                                             document.getElementById('play').disabled = true;
                                                             document.getElementById('stop').disabled = false;
                                                             });
            document.getElementById('stop').addEventListener('click', function() {
                                                             sound.stop(0);
                                                             sound.isPlaying = false;
                                                             document.getElementById('play').disabled = false;
                                                             document.getElementById('stop').disabled = true;
                                                             });
            document.getElementById('N1').addEventListener('click', function() {
                                                           orderOut = 1;
                                                           orderValue.innerHTML = orderOut;
                                                           limiter.updateOrder(orderOut);
                                                           limiter.out.connect(decoder.in);
                                                           });
            document.getElementById('N2').addEventListener('click', function() {
                                                           orderOut = 2;
                                                           orderValue.innerHTML = orderOut;
                                                           limiter.updateOrder(orderOut);
                                                           limiter.out.connect(decoder.in);
                                                           });
            document.getElementById('N3').addEventListener('click', function() {
                                                           orderOut = 3;
                                                           orderValue.innerHTML = orderOut;
                                                           limiter.updateOrder(orderOut);
                                                           limiter.out.connect(decoder.in);
                                                           });

            function changeSample() {
                document.getElementById('play').disabled = true;
                document.getElementById('stop').disabled = true;
                soundUrl = document.getElementById("sample_no").value;
                if (sound.isPlaying) {
                    sound.stop(0);
                    sound.isPlaying = false;
                }
                loader_sound = new HOAloader(context, maxOrder, soundUrl, assignSoundBufferOnLoad);
                loader_sound.load();
            }

        </script>

    </body>
</html>