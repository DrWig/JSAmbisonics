<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <meta name="description" content="Web Audio ambisonic library tests"/>
        <meta name="author" content="Archontis Politis"/>
        <title>Ambisonics on the browser: B-format Intensity Analyser I</title>
    </head>
    <body>
        
        <h1>B-format panner and intensity analyser</h1>
        
        <button id="play">Play</button> <button id="stop">Stop</button>
        <br>
        
        <p>Click on the map to pan the source</p>
        <canvas id="Canvas" width="820" height="412"></canvas>
        <br>
        Azimuth:
        <span id="azi-value">0</span>
        Elevation:
        <span id="elev-value">0</span>
        <br>

        <p>Intensity Visualizer</p>
        <canvas id="Canvas2" width="820" height="412"></canvas>
        
        <footer>
            <hr>
            <p>Archontis Politis, 2016</p>
            <a href="mailto:archontis.politis@aalto.fi">archontis.politis@aalto.fi</a>
        </footer>
        
        <script type="text/javascript" src="../WebAudio_FOA.js"></script>
        
        <script>

            ////////////////////////////////////////////////
            // SET-UP WEB AUDIO CONTEXT AND SOUND PROCESSING
            var AudioContext = window.AudioContext // Default
            || window.webkitAudioContext; // Safari and old versions of Chrome
            var context = new AudioContext; // Create and Initialize the Audio Context
            var soundUrl = "./sounds/sample1.wav";
            var irUrl = "./filters/BF_filters_direct.wav";
            var soundBuffer, sound;

            // initialize B-format blocks
            var encoder = new Bformat_encoder(context);
            var decoder = new Bformat_binDecoder(context);
            var analyser = new Bformat_analyser(context);
            // make connections
            encoder.out.connect(analyser.in);
            analyser.out.connect(decoder.in);
            decoder.out.connect(context.destination);

            // function to load samples
            function loadSample(url, doAfterLoading) {
                var fetchSound = new XMLHttpRequest(); // Load the Sound with XMLHttpRequest
                fetchSound.open("GET", url, true); // Path to Audio File
                fetchSound.responseType = "arraybuffer"; // Read as Binary Data
                fetchSound.onload = function() {
                context.decodeAudioData(fetchSound.response, doAfterLoading);
                }
                fetchSound.send();
            }
            // function to assign sample to the sound buffer for playback (and enable playbutton)
            var assignSample2SoundBuffer = function(decodedBuffer) {
                soundBuffer = decodedBuffer;
                document.getElementById('play').disabled = false;
            }
            // function to assign sample to the filter buffers for convolution
            var assignSample2Filters = function(decodedBuffer) {
                decoder.updateFilters(decodedBuffer);
            }

            // load and assign samples
            document.getElementById('play').disabled = true;
            document.getElementById('stop').disabled = true;
            loadSample(soundUrl, assignSample2SoundBuffer);
            loadSample(irUrl, assignSample2Filters);

            // handle buttons
            document.getElementById('play').addEventListener('click', function() {
                                             sound = context.createBufferSource();
                                             sound.buffer = soundBuffer;
                                             sound.loop = true;
                                             sound.connect(encoder.in);
                                             sound.start(0);
                                             sound.isPlaying = true;
                                             document.getElementById('play').disabled = true;
                                             document.getElementById('stop').disabled = false;
                                             });
            document.getElementById('stop').addEventListener('click', function() {
                                             sound.stop(0);
                                             sound.isPlaying = false;                
                                             document.getElementById('play').disabled = false;
                                             document.getElementById('stop').disabled = true;
                                             });

            ////////////////////////////
            // SET-UP GUI AND USER INPUT
            var canvas = document.getElementById('Canvas');
            var canvas_context = canvas.getContext("2d");
            var mouseDown = false;
            var aziValue = document.getElementById('azi-value');
            var elevValue = document.getElementById('elev-value');

            // Map sprite
            var mapSprite = new Image();
            mapSprite.src = "./resources/map.png";

            // Create a simple class for the markers
            var Marker = function () {
                this.Sprite = new Image();
                this.Sprite.src = "./resources/cursor.png"
                this.Width = 30;
                this.Height = 30;
                this.XPos = 0;
                this.YPos = 0;
            }
            var marker = new Marker();

            // When the user clicks their mouse on our canvas run this code
            function mouseAction(mouse) {
                // Get current mouse coords
                var rect = canvas.getBoundingClientRect();
                var mouseXPos = (mouse.clientX - rect.left);
                var mouseYPos = (mouse.clientY - rect.top);
                
                // Update webaudio
                var angleX = -Math.round(360*(mouseXPos - (rect.width/2))/rect.width);
                var angleY = Math.round(180*((rect.height/2) - mouseYPos)/rect.height);
                encoder.azi = angleX;
                encoder.elev = angleY;
                encoder.updateGains();
                aziValue.innerHTML = angleX;
                elevValue.innerHTML = angleY;
                
                // Move the marker when placed to a better location
                marker.XPos = mouseXPos - (marker.Width/2);
                marker.YPos = mouseYPos - (marker.Height/2);
            }

            // Add mouse click event listener to canvas
            canvas.addEventListener("mousedown", function(mouse) {
                                    mouseDown = true;
                                    mouseAction(mouse);
                                    }, false);

            canvas.addEventListener("mousemove", function(mouse) {
                                    if (mouseDown) mouseAction(mouse);
                                    }, false);

            canvas.addEventListener("mouseup", function(mouse) {
                                    mouseDown = false;
                                    }, false);
            
            var canvas2 = document.getElementById('Canvas2');
            var canvas2_context = canvas2.getContext("2d");
            var circles = [];
            var numCircleLim = 30;
            var opacityLim = 0.2;
            
            function Circle(xPos, yPos, radius, opacity) {
                this.xPos = xPos;
                this.yPos = yPos;
                this.radius = radius;
                this.opacity = opacity;
            }
            Circle.prototype.draw = function(context) {
                
                context.beginPath();
                context.arc(this.xPos, this.yPos, this.radius, 0, Math.PI * 2, false);
                context.closePath();
                
                context.fillStyle = 'rgba(185, 211, 238,' + this.opacity + ')';
                context.fill();
            };
        
            function angles2pixels(azi, elev, cnv) {
                var rect = cnv.getBoundingClientRect();
                var xy = [];
                xy[0] = Math.round(-azi*rect.width/360 + rect.width/2);
                xy[1] = Math.round(rect.height/2 - elev*rect.height/180);
                return xy;
            }
            function updateCircles(params, cnv) {
                var xy = angles2pixels(params[0], params[1], cnv);
                var radius = 30*(1-params[2]);
                var opacity = 1;
                
                if (circles.length<numCircleLim) {
                    var circle = new Circle(xy[0], xy[1], radius, opacity);
                    circles.push(circle);
                }
                else {
                    var circle = new Circle(xy[0], xy[1], radius, opacity);
                    circles.shift();
                    circles.push(circle);
                    for (var i=0; i<numCircleLim-1; i++) circles[i].opacity = opacityLim + i*(1-opacityLim)/numCircleLim;
                }
            }

            function draw() {
                requestAnimationFrame(draw);
                
                // Clear Canvas
                canvas_context.fillStyle = "#000";
                canvas_context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw map
                canvas_context.drawImage(mapSprite, 0, 0);
                
                // Draw marker
                canvas_context.drawImage(marker.Sprite, marker.XPos, marker.YPos, marker.Width, marker.Height);
                
                // Update audio analyser buffers
                analyser.updateBuffers();
                var params = analyser.computeIntensity();
                updateCircles(params, canvas);
                
                // Clear Canvas
                canvas2_context.fillStyle = "#000";
                canvas2_context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw map
                canvas2_context.drawImage(mapSprite, 0, 0);
                
                // Draw Circles
                for (var i=0; i<circles.length; i++) circles[i].draw(canvas2_context);

            };
            draw();

        </script>

    </body>
</html>